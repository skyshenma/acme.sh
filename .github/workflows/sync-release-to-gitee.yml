name: åŒæ­¥ GitHub Releases âœ Gitee ï¼ˆå«é™„ä»¶ï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 3 * * *'  # æ¯æ—¥å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨è¿è¡Œï¼ˆUTCï¼‰

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§³ Checkout ä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ§± æ„å»ºå®‰è£…åŒ…ï¼ˆä¾‹å¦‚ acme.sh.tar.gzï¼‰
        run: |
          mkdir dist
          tar -czf dist/acme.sh.tar.gz ./acme.sh

      - name: ğŸ“¦ è·å– GitHub Releases å¹¶æ¨é€è‡³ Gitee
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          upstream="${{ secrets.UPSTREAM_REPO }}"      # å¦‚ acmesh-official/acme.sh
          gitee_repo="${{ secrets.GITEE_REPO }}"        # å¦‚ skyshenma/acme.sh

          echo "è·å– GitHub Releases..."
          gh release list --limit 10 | while read -r line; do
            tag=$(echo "$line" | cut -f1)
            name=$(echo "$line" | cut -f3)
            echo "å¤„ç†å‘å¸ƒç‰ˆæœ¬: $tag"

            # è·å– Release æè¿°
            body=$(gh release view "$tag" --json body -q .body | jq -Rs '.')

            # åˆ›å»º Gitee Release
            curl -X POST "https://gitee.com/api/v5/repos/$gitee_repo/releases" \
              -H "Content-Type: application/json" \
              -d "{
                    \"access_token\": \"$GITEE_TOKEN\",
                    \"tag_name\": \"$tag\",
                    \"name\": \"$name\",
                    \"body\": $body
                  }"

            # ä¸Šä¼ é™„ä»¶ï¼ˆå®‰è£…åŒ…ï¼‰
            curl -X POST "https://gitee.com/api/v5/repos/$gitee_repo/releases/$tag/assets?access_token=$GITEE_TOKEN" \
              -F name="acme.sh.tar.gz" \
              -F attachment=@dist/acme.sh.tar.gz

          done
