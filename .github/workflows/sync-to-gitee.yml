name: GitHub âœ Gitee è‡ªåŠ¨å¹¶å‘åŒæ­¥ï¼ˆç»ˆæå¢å¼ºç‰ˆï¼‰

on:
  push:
    branches:
      - master
      - dev
      - sync_to_gitee
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§³ Checkout ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ”§ Git ç”¨æˆ·é…ç½®
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ğŸ” å¯ç”¨ Gitee SSH ç§é’¥
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.GITEE_RSA_PRIVATE_KEY }}

      - name: ğŸ§· ä¿¡ä»» Gitee SSH ä¸»æœºå¯†é’¥
        run: ssh-keyscan gitee.com >> ~/.ssh/known_hosts

      - name: ğŸ” æ·»åŠ è¿œç¨‹ä»“åº“
        run: |
          git remote add upstream https://github.com/${{ secrets.UPSTREAM_REPO }}.git
          git remote add gitee git@gitee.com:${{ secrets.GITEE_REPO }}.git

      - name: ğŸ”„ åŒæ­¥ master å’Œ dev åˆ†æ”¯
        run: |
          for branch in master dev; do
            echo "åŒæ­¥åˆ†æ”¯ï¼š$branch"
            git fetch upstream $branch
            git checkout -B $branch upstream/$branch
            git push -f gitee $branch
          done

      - name: ğŸ·ï¸ åŒæ­¥ Tagsï¼ˆç‰ˆæœ¬æ ‡ç­¾ï¼‰
        run: |
          git fetch upstream --tags
          for tag in $(git tag); do
            git push gitee tag $tag || echo "Tag $tag å·²å­˜åœ¨æˆ–æ¨é€å¤±è´¥ï¼Œè·³è¿‡"
          done

      - name: ğŸ“¦ åŒæ­¥ Releases
        uses: actions/github-script@v6
        with:
          script: |
            const upstream = '${{ secrets.UPSTREAM_REPO }}';
            const { data: releases } = await github.rest.repos.listReleases({
              owner: upstream.split('/')[0],
              repo: upstream.split('/')[1],
              per_page: 100
            });

            for (const release of releases) {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: release.tag_name,
                name: release.name,
                body: release.body || '',
                draft: release.draft,
                prerelease: release.prerelease
              }).catch(error => {
                console.log(`Release ${release.tag_name} å·²å­˜åœ¨æˆ–å¤±è´¥ï¼Œè·³è¿‡`);
              });
            }

      - name: ğŸ›¡ï¸ è·³è¿‡ sync_to_gitee åˆ†æ”¯å¤„ç†
        if: github.ref == 'refs/heads/sync_to_gitee'
        run: echo "ä¿æŠ¤ sync_to_gitee åˆ†æ”¯ï¼Œä¸è¿›è¡ŒåŒæ­¥"

      - name: âœ… æ‰‹åŠ¨è§¦å‘æç¤º
        if: github.event_name == 'workflow_dispatch'
        run: echo "åŒæ­¥å®Œæˆï¼ï¼ˆmaster/dev/tags/releasesï¼‰å·²æ¨é€åˆ° Gitee"

