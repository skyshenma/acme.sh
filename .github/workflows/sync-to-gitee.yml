name: GitHub ➜ Gitee 同步 master & dev 分支

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 每 6 小时自动运行一次

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      GITEE_REPO: ${{ secrets.GITEE_REPO }}
      UPSTREAM_REPO: ${{ secrets.UPSTREAM_REPO }}

    steps:
      - name: 设置 SSH 推送到 Gitee
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.GITEE_RSA_PRIVATE_KEY }}

      - name: 克隆你的 GitHub 仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 配置 Git 和添加 upstream 远程源
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/${UPSTREAM_REPO}
          git fetch upstream

      - name: 同步 master 和 dev 分支并推送到 Gitee
        run: |
          for branch in master dev; do
            git checkout $branch || git checkout --track upstream/$branch
            git pull upstream $branch --rebase
            git push origin $branch
            git remote add gitee git@gitee.com:${GITEE_REPO}.git || true
            git push gitee $branch
          done
